<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>What if someone disables CloudTrail in a Centralised Logging Scenario?</title>
<meta name="description" content="This article details one of the many ways of addressing the scenario where logging is crucial and a centralised logging account is setup in a multi account a...">
<!-- Font Awesome -->
<link rel="stylesheet" href="/css/font-awesome.min.css">
	
<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://localhost:4000/blog/2019/enforcing-cloudtrail/">
<link rel="alternate" type="application/rss+xml" title="A Curious Engineer" href="http://localhost:4000/feed.xml" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-143160087-1', 'auto');
  ga('send', 'pageview');
</script>


</head>
<body>
  <header class="site-header">
  <div class="container">
    <input type="checkbox" id="toggleNavbar">
    <h1 class="logo"><a href="/">A<span> Curious</span> Engineer</a></h1>
    <label for="toggleNavbar" role="button" class="toggle-navbar-button">
      <i class="icon icon-menu"></i>
      <i class="icon icon-cross"></i>
    </label>
    <nav class="navbar">
      <ul>
        <li><a href="/" title="Home">Home</a></li>
        
          <li><a href="/about" title="About">About</a></li>
        
          <li><a href="/blog" title="Blog">Blog</a></li>
        
        
      </ul>
    </nav>
  </div>
</header>


<main class="main-container">
  <div class="container">
    <article role="article" class="post">

  <div class="card">
    <header class="post-header">
      <h1 class="post-title">What if someone disables CloudTrail in a Centralised Logging Scenario?</h1>
      <em class="post-meta">
        <time>Jun 6, 2019</time>
      </em>
    </header>

    <div class="post-content">
      
      <p>This article details one of the many ways of addressing the scenario where logging is crucial and a centralised logging account is setup in a multi account architecture. Of course, you can enforce service control policies at the root level to avoid any tampering with the logging mechanism, which is a proactive approach, but I wanted to talk about the reactive approach: What if someone disables CloudTrail logging in one of the member accounts?</p>

<p>I did some research online to find a AWS Organizations centric approach for enforcing Cloudtrail and all I could find was an approach tailored for a single account on Linux Academy. I took the learnings from that tutorial and tried an approach to enforce CloudTrail in a multi-account scenario.</p>

<p>To better explain the situation, consider the below scenario:</p>

<p>Acme Corp. is an enterprise comprised of over 5000 employees and 100 departments. They are in the transition period from on-premise to cloud infrastructure and want to isolate certain departments per industry’s standard best practices. The solution architect, responsible for the migration, started with a root account (parent account) and created multiple member accounts (child accounts) and organized them into units. To ensure that the architecture meets certain auditing and compliance standards, the architect recommended a central logging and auditing account which collects logs from all the member accounts and stores them.</p>

<p>But what if someone tries to disable the logging in one of the member accounts?</p>

<p>And if you are new to the concepts and functionalities of AWS Organisations, cross account access roles, creating centralised logging, please refer to the below links:</p>

<ol>
  <li><a href="https://docs.aws.amazon.com/organizations/latest/userguide/orgs_tutorials_basic.html">Setup AWS organization and member accounts</a></li>
  <li><a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/tutorial_cross-account-with-roles.html">Enable Cross-Account access</a></li>
  <li><a href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-getting-started.html">Enable cloudtrail on the member accounts</a></li>
  <li><a href="https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-receive-logs-from-multiple-accounts.html">Create central logging repository on AWS S3 for cloudtrail logs.</a></li>
</ol>

<p><b>Actions to be taken in Parent Account<b></b></b></p>
<ol>
  <li>Once all the prerequisites have been met, navigate to your parent account’s (root account) CloudWatch console and select “Event Bus” and add a permission for the child account to send events to the parent account by entering the account number of the child account.</li>
</ol>

<p><img class="mb-2" src="/images/parent1.png" alt="" height="400" width="900" /></p>

<ol>
  <li>Navigate to the Lambda console and create a function and use the code below. The code  is well documented but feel free to drop in a comment for further clarification.</li>
</ol>

<pre><code class="language-python">import boto3

def lambda_handler(event, context):
     # create an STS client object that represents a live connection
	sts_client = boto3.client('sts')    
	sender_account_id = event['account']
    sender_account_region = event['region']
    
    
    # Call the assume_role method of the STSConnection object and pass the role
    assumedRoleObject = sts_client.assume_role(
        RoleArn="arn:aws:iam::"+sender_account_id+":role/AccesstoDev",
        RoleSessionName="AccesstoDev"
    )
    
   #get the temporary credentials that can be used to make subsequent API calls
    credentials = assumedRoleObject['Credentials']
    
    # Use the temporary credentials that AssumeRole returns to make a 
    # connection to Amazon Cloudtrail  
    cloudtrail_resource = boto3.client(
        'cloudtrail',
        aws_access_key_id = credentials['AccessKeyId'],
        aws_secret_access_key = credentials['SecretAccessKey'],
        aws_session_token = credentials['SessionToken'],
    )

    # Use the Amazon cloudtrail resource object that is now configured to start the trail.
  
    cloudtrail_resource.start_logging(Name='arn:aws:cloudtrail:'+sender_account_region+':'+sender_account_id+':trail/devaccount-trail')


</code></pre>
<p>PS: Exception handlers are being included and the work is in progress. The code will be updated once done. For a PoC, this serves the purpose</p>

<ol>
  <li>
    <p>Configure a rule on CloudWatch which triggers a lambda function and sends notification on a SNS topic for every CloudTrail event it receives. To be precise for our requirement, we can specify the name of the event for which the CloudWatch rule has to fire up. Let’s configure the CloudWatch rule to trigger on “StopLogging” event name.</p>
  </li>
  <li>
    <p>Add another target as a SNS topic, if you want an administrator to be notified of this event. Select the SNS topic you created as the target.</p>
  </li>
</ol>

<p><img class="mb-2" src="/images/parent2.png" alt="" height="400" width="900" /></p>

<p><b>Actions to be completed in Child Account<b></b></b></p>
<ol>
  <li>Navigate to the CloudWatch console and create a rule to send any notification to the event bus created in the parent account. Select the “Event bus in another account” as target and enter the account number of the account where we created the event bus.</li>
</ol>

<p>Now all we need to do is turn of the CloudTrail in the child account and watch it turn itself back on.</p>

<p>If you think of a better way to do it, please do let me know at yyellapragada@gmail.com.</p>

    </div>

    
<hr>

<aside id="comments" class="disqus">
  <h3><i class="icon icon-comments-o"></i> Comments</h3>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = 'http://localhost:4000/blog/2019/enforcing-cloudtrail/';
      this.page.identifier = '/blog/2019/enforcing-cloudtrail';
    };
    (function() {
      var d = document,
      s = d.createElement('script');
      s.src = '//a-conversant-engineer.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</aside>


  </div>

</article>

  </div>
</main>

<footer class="site-footer">
  <div class="container">
    <ul class="social">
  <li><a href="https://github.com/YYashwanth" target="_blank"><i class="fa fa-github"></i></a></li>
  <li><a href="https://www.facebook.com/yashwanth.yellapragada" target="_blank"><i class="fa fa-facebook"></i></a></li>
  <li><a href="https://www.linkedin.com/in/yyellapragada/" target="_blank"><i class="fa fa-linkedin"></i></a></li>
</ul>
    <p class="txt-medium-gray">
      <small>&copy;2019 All rights reserved. Made with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and ♥</small>
    </p>
  </div>
</footer>


</body>
</html>
