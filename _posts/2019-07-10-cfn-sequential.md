---
layout: post
title: "Bootstrapping EC2 Windows Instance using SSM Documents and Cloudformation - Part 2"
description: "Using AWS Cloudformation and AWS SSM Documents to bootstrap an instance"
date: 2019-07-10 12:15:18
comments: true
description: "Bootstrapping Windows EC2"
keywords: "AWS, Bootstrapping, AWS Systems Manager, AWS System Manager Documents, Cloudformation, Automation, SSM Documents"
categories:
    - Amazon Web Services
tags:
- AWS
- Automation
- Cloudformation
- AWS Systems Manager
---

### This article will utilize the SSM documents created in Part 1 of this series through CloudFormation

Please read part 1 of the article [here](../cfn-ssm)

So, in order to create a proper sequence of installations and configurations, I created separate SSM documents for installing and configuring Datadog, Sophos and other softwares and associated those documents with the instance using <b>SSM Association</b> resource type in CloudFormation. 

<h2> What is SSM Association resource type in CloudFormation? </h2>

This resource creates a link between the document and the EC2 instance, so whenever the SSM document, which is linked to the EC2 instance, is updated, it is run again against that associated instance. 

```yaml
Association:
    Type: AWS::SSM::Association
    DependsOn: WaitHandle
    Properties:
      Name: 'Name of the SSM document'
      Parameters:
        CallbackHandle:
          - Ref: WaitHandle
      Targets:
        - Key: InstanceIds
          Values: 'InstanceId'
 ```

If you'd like to read more about the SSM Association Resource Type, refer <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-ssm-association.html">this documentation by AWS.</a>

I used the <b>DependsOn</b> attribute in CloudFormation to create of sequence of installations and configurations required to bootstrap the EC2 instance. But there is no way to know if a software installation is complete within the EC2 instance. To solve this, I created a <b>Wait Handle</b> in the CloudFormation template and passed that wait handle url as an input to the SSM document via the SSM Association resource type and accessed that wait handle from within the SSM document. 

<h2>What is DependsOn attribute in Cloudformation?</h2>

This attribute helps in creating a sequence of steps if the order of execution is a priority. 

```yaml

SetTimeZone:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        EC2InstanceId:
          !Ref EC2InstanceId
        SSMDocumentName: 'Set-USTimeZone'
      TemplateURL: <template url hosted in an s3 bucket>
      
InstallDataDog:
    Type: AWS::CloudFormation::Stack
    DependsOn: SetTimeZone
    Properties:
      Parameters:
        EC2InstanceId:
          !Ref EC2InstanceId
        SSMDocumentName: 'Install-DataDog'
      TemplateURL: <template url hosted in an s3 bucket>

```

As you can see in the above code, the resource <b>InstallAntiVirus</b> only executes if <b>SetTimeZone</b> resource has been successfully executed.

If you'd like to read more about the DependsOn attribute, refer <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-attribute-dependson.html">this documentation by AWS.</a>

<h2>What are Wait Conditions in Cloudformation?</h2>

We can make use of Wait Conditions and wait condition handle resources in CloudFormation to pause the creation of the stack and wait for a signal before resuming the stack creation.

```yaml

Resources:
  DataDogWaitHandle:
    Type: AWS::CloudFormation::WaitConditionHandle

  DataDogAssociation:
    Type: AWS::SSM::Association
    DependsOn: DataDogWaitHandle
    Properties:
      Name: 'DataDogSSMDocumentName'
      Parameters:
        CallbackHandle:
          - Ref: DataDogWaitHandle
      Targets:
        - Key: InstanceIds
          Values: 'InstanceID'

  DataDogCallBack:
    Type: AWS::CloudFormation::WaitCondition
    DependsOn: DataDogWaitHandle
    Properties:
      Handle:
        Ref: DataDogWaitHandle
      Timeout: '1800'

```

As shown in the image, a <b> DataDogWaitHandle </b> resource is created and passed as a parameter to the SSM document. And the <b>DataDogCallBack</b> resource waits for a signal to be received on the url generated by the wait handle.

As seen in an earlier [post](../cfn-ssm), we created an SSM document that can signal back to CloudFormation after installing and configuring a software. As soon as <b>DataDogCallBack</b> receives a signal, it marks itself as complete. If a signal (success/failure) is not received within 1800 seconds, the resource fails.

We can repeat this process for each bootstrapping sequence i.e., Installing Datadog, Installing Antivirus, Installing Web Server etc., where installation of anti-virus is dependent on the completion of Datadog and so on.

This way, it is easy to coordinate the process of bootstrapping the windows instance along with the entire CloudFormation stack creation.

This is one of the many ways to coordinate the creation of a CloudFormation stack and bootstrapping an instance. If you think of a better way, please do comment below. If this post helped you in any way, share your experience. 

Always happy to learn!





